name: ğŸ›ï¸ Nefer CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  FLUTTER_VERSION: '3.16.0'
  DART_VERSION: '3.2.0'

jobs:
  # =============================================================================
  # CODE QUALITY & TESTING
  # =============================================================================
  
  analyze:
    name: ğŸ“Š Code Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        
    - name: ğŸ“¦ Get Flutter dependencies
      run: flutter pub get
      
    - name: ğŸ” Analyze Flutter code
      run: flutter analyze
      
    - name: ğŸ¯ Check formatting
      run: dart format --set-exit-if-changed .
      
    - name: âš¡ Analyze Dart functions
      run: |
        cd functions
        dart pub get
        dart analyze

  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        
    - name: ğŸ“¦ Get dependencies
      run: flutter pub get
      
    - name: ğŸ§ª Run Flutter tests
      run: flutter test --coverage
      
    - name: âš¡ Run Dart functions tests
      run: |
        cd functions
        dart pub get
        dart test
        
    - name: ğŸ“Š Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: coverage/lcov.info

  # =============================================================================
  # BUILD JOBS
  # =============================================================================
  
  build-web:
    name: ğŸŒ Build Web
    runs-on: ubuntu-latest
    needs: [analyze, test]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        
    - name: ğŸ“¦ Get dependencies
      run: flutter pub get
      
    - name: ğŸ—ï¸ Build web
      run: flutter build web --release --web-renderer html
      
    - name: ğŸ“¤ Upload web artifacts
      uses: actions/upload-artifact@v3
      with:
        name: web-build
        path: build/web/

  build-functions:
    name: âš¡ Build Functions
    runs-on: ubuntu-latest
    needs: [analyze, test]
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ¯ Setup Dart
      uses: dart-lang/setup-dart@v1
      with:
        sdk: ${{ env.DART_VERSION }}
        
    - name: ğŸ“¦ Get dependencies
      run: |
        cd functions
        dart pub get
        
    - name: ğŸ—ï¸ Build functions
      run: |
        cd functions
        dart compile exe bin/main.dart -o bin/server
        
    - name: ğŸ“¤ Upload functions artifacts
      uses: actions/upload-artifact@v3
      with:
        name: functions-build
        path: functions/bin/server

  build-android:
    name: ğŸ¤– Build Android
    runs-on: ubuntu-latest
    needs: [analyze, test]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: â˜• Setup Java
      uses: actions/setup-java@v3
      with:
        distribution: 'zulu'
        java-version: '17'
        
    - name: ğŸ¦ Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        
    - name: ğŸ“¦ Get dependencies
      run: flutter pub get
      
    - name: ğŸ—ï¸ Build APK
      run: flutter build apk --release
      
    - name: ğŸ“¤ Upload APK
      uses: actions/upload-artifact@v3
      with:
        name: android-apk
        path: build/app/outputs/flutter-apk/app-release.apk

  # =============================================================================
  # DEPLOYMENT JOBS
  # =============================================================================
  
  deploy-staging:
    name: ğŸ­ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-web, build-functions]
    if: github.ref == 'refs/heads/develop'
    environment: staging
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download web build
      uses: actions/download-artifact@v3
      with:
        name: web-build
        path: build/web/
        
    - name: ğŸ“¥ Download functions build
      uses: actions/download-artifact@v3
      with:
        name: functions-build
        path: functions/bin/
        
    - name: ğŸ”¥ Setup Firebase CLI
      uses: w9jds/firebase-action@master
      with:
        args: use staging
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        
    - name: ğŸš€ Deploy to Firebase
      uses: w9jds/firebase-action@master
      with:
        args: deploy
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

  deploy-production:
    name: ğŸ­ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-web, build-functions, build-android]
    if: github.ref == 'refs/heads/main'
    environment: production
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download web build
      uses: actions/download-artifact@v3
      with:
        name: web-build
        path: build/web/
        
    - name: ğŸ“¥ Download functions build
      uses: actions/download-artifact@v3
      with:
        name: functions-build
        path: functions/bin/
        
    - name: ğŸ”¥ Setup Firebase CLI
      uses: w9jds/firebase-action@master
      with:
        args: use production
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        
    - name: ğŸš€ Deploy to Firebase
      uses: w9jds/firebase-action@master
      with:
        args: deploy
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        
    - name: ğŸ“± Upload to Play Store (Internal Testing)
      if: success()
      uses: r0adkll/upload-google-play@v1
      with:
        serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
        packageName: com.nefer.ecommerce
        releaseFiles: build/app/outputs/flutter-apk/app-release.apk
        track: internal

  # =============================================================================
  # SECURITY & MONITORING
  # =============================================================================
  
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Run security scan
      uses: securecodewarrior/github-action-add-sarif@v1
      with:
        sarif-file: 'security-scan-results.sarif'
        
    - name: ğŸ“Š Upload SARIF results
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: security-scan-results.sarif

  # =============================================================================
  # NOTIFICATIONS
  # =============================================================================
  
  notify:
    name: ğŸ“¢ Notify Team
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always()
    
    steps:
    - name: ğŸ“¢ Slack Notification
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        channel: '#nefer-deployments'
        text: |
          ğŸ›ï¸ Nefer Deployment Status: ${{ job.status }}
          Branch: ${{ github.ref }}
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
